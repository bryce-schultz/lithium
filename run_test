#!/usr/bin/env bash

# Usage: run_test <test_name> [-v]
# Runs the interpreter on tests/<test_name>.li, compares output to .correct, and returns 0 if the test passes.

if [[ -z "$1" ]]; then
  echo "Usage: $0 <test_name> [-v]"
  exit 1
fi

test_name="$1"
verbose=0
[[ "$2" == "-v" ]] && verbose=1

if [[ ! -d "tests" ]]; then
  echo "Tests directory does not exist."
  exit 1
fi

cd tests || exit 1

# If test_name contains subdirectories, cd into them
if [[ "$test_name" == */* ]]; then
  test_dir="${test_name%/*}"
  test_base="${test_name##*/}"
  if [[ ! -d "$test_dir" ]]; then
    echo "Directory $test_dir does not exist."
    exit 1
  fi
  cd "$test_dir" || exit 1
else
  test_base="$test_name"
fi

test_file="${test_base}.li"
expected_file="${test_base}.correct"
output_file="${test_base}.out"

if [[ ! -f "$test_file" ]]; then
  echo "Test file $test_file does not exist."
  exit 1
fi
if [[ ! -f "$expected_file" ]]; then
  echo "Expected output file $expected_file does not exist."
  exit 1
fi

lithium=$(command -v li)
if [[ -z "$lithium" ]]; then
  echo "Lithium interpreter not found in PATH."
  exit 1
fi

"$lithium" "$test_file" > "$output_file"
if diff -b "$output_file" "$expected_file" > /dev/null; then
  rm "$output_file"
  exit 0
else
  [[ $verbose -eq 1 ]] && {
    echo "Test $test_name failed."
    diff -b "$output_file" "$expected_file"
  }
  exit 1
fi